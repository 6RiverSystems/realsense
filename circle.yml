machine:
  pre:
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
  services:
    - docker
  environment:
    ARCH: x86_64
    ROS_DISTRO: indigo
    ROS_BUILD_IMAGE: 6river/rosbuild-$ROS_DISTRO-$ARCH

dependencies:
  cache_directories:
    - output/.ccache
  post:
    - git submodule init
    - git submodule update --recursive
    - docker run -v $PWD/output:/mfp_workspace -v $PWD:/mfp_workspace/src -e CCACHE_DIR=/mfp_workspace/.ccache -it $ROS_BUILD_IMAGE /bin/bash -C "cd /mfp_workspace && /mfp_workspace/src/srsbot_chuck/scripts/run_unit_tests.sh"

checkout:
  post:
    - mkdir -p $PWD/output

test:
  override:
    - docker run -v $PWD/output:/mfp_workspace -v $PWD:/mfp_workspace/src -e CCACHE_DIR=/mfp_workspace/.ccache -it $ROS_BUILD_IMAGE /bin/bash -C "/mfp_workspace && /mfp_workspace/src/srsbot_chuck/scripts/unit_test_results.sh"
  post:
    - mkdir -p $CIRCLE_TEST_REPORTS/junit/
    - find $PWD/output/build/test_results -type f -name '*.xml' -exec cp {} $CIRCLE_TEST_REPORTS/junit/ \;
