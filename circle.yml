machine:
  pre:
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
  services:
    - docker

dependencies:
  cache_directories:
    - "~/.ccache"
  override:
    - docker info
    - docker pull 6river/rosbuild-armhf

checkout:
  post:
    - mkdir -p ~/install
    - mkdir -p ~/test_results
    - mkdir -p ~/artifacts
    - mkdir -p $CIRCLE_TEST_REPORTS/junit/

test:
  override:
    - docker run -v $CIRCLE_TEST_REPORTS/junit:/mfp_workspace/build/test_results/junit -v $PWD/:/mfp_workspace/src -v $PWD/.ccache:/ccache -e CCACHE_DIR=/ccache --privileged -it ros-build-debian-armhf /bin/bash -C "/mfp_workspace/src/srsbot_chuck/scripts/run_unit_tests.sh"
    - docker run -v $PWD/install:/mfp_workspace/install -v $PWD/:/mfp_workspace/src -v $PWD/.ccache:/ccache -e CCACHE_DIR=/ccache --privileged -it ros-build-debian-armhf /bin/bash -C "/mfp_workspace/src/srsbot_chuck/scripts/build_install.sh"

deployment:
  branch: master
  commands:
    - $PWD/srsbot_chuck/scripts/deploy_artifact.sh
